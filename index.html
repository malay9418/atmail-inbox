<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Temp Mail Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <style>
        .copy-button {
            cursor: pointer;
            background-color: #4CAF50;
            color: white;
            padding: 6px 10px;
            border: none;
            border-radius: 5px;
            margin-left: 10px;
        }
    </style>
    <script>
        async function fetchNamespace() {
            try {
                const response = await fetch('/namespace');
                const data = await response.json();
                return data.namespace;
            } catch (error) {
                console.error('Failed to fetch namespace:', error);
                return null;
            }
        }

        async function generateNewMail() {
            try {
                const namespace = await fetchNamespace();
                if (!namespace) {
                    console.error('Namespace not found');
                    return;
                }
                const tag = generateRandomTag();
                const email = `${namespace}.${tag}@inbox.testmail.app`;
                localStorage.setItem('tempmailTag', tag);
                localStorage.setItem('tempmailNamespace', namespace);
                displayCurrentEmail(email);
                fetchEmails(tag);
            } catch (error) {
                console.error('Failed to generate new mail:', error);
            }
        }

        async function fetchEmails(tag) {
            try {
                const namespace = localStorage.getItem('tempmailNamespace');
                const response = await fetch(`/mails?tag=${namespace}.${tag}`);
                const data = await response.json();
                displayEmails(data.emails);
            } catch (error) {
                console.error('Failed to fetch emails:', error);
            }
        }

        function displayEmails(emails) {
            const emailList = document.getElementById('emailList');
            emailList.innerHTML = '';
            emails.forEach(email => {
                const emailItem = document.createElement('div');
                emailItem.className = 'bg-gray-100 p-4 rounded-lg mb-4';
                emailItem.innerHTML = `
                    <p><strong>From:</strong> ${email.from}</p>
                    <p><strong>Subject:</strong> ${email.subject}</p>
                    <p><strong>Date:</strong> ${new Date(email.date).toLocaleString()}</p>
                    <p><strong>Text:</strong> ${email.text}</p>
                `;
                emailList.appendChild(emailItem);
            });
        }

        function displayCurrentEmail(email) {
            document.getElementById('currentEmail').textContent = email;
            const copyButton = document.getElementById('copyButton');
            copyButton.setAttribute('data-clipboard-text', email);
        }

        function copyToClipboard() {
            const email = document.getElementById('currentEmail').textContent;
            const textarea = document.createElement('textarea');
            textarea.value = email;
            textarea.style.position = 'fixed';
            document.body.appendChild(textarea);
            textarea.focus();
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            alert('Email copied to clipboard!');
        }

        document.addEventListener('DOMContentLoaded', async () => {
            const tag = localStorage.getItem('tempmailTag');
            const namespace = localStorage.getItem('tempmailNamespace');
            if (!tag || !namespace) {
                await generateNewMail();
            } else {
                const currentEmail = `${namespace}.${tag}@inbox.testmail.app`;
                displayCurrentEmail(currentEmail);
                fetchEmails(tag);
            }
        });

        function refreshEmails() {
            const tag = localStorage.getItem('tempmailTag');
            const namespace = localStorage.getItem('tempmailNamespace');
            if (tag && namespace) {
                fetchEmails(tag);
            } else {
                generateNewMail();
            }
        }
    </script>
</head>
<body class="bg-gray-100 font-sans leading-normal tracking-normal">

    <div class="container mx-auto my-10 p-5">
        <div class="text-center mb-10">
            <h1 class="text-4xl font-bold">Temp Mail Dashboard</h1>
            <p class="text-lg mt-2">Manage your temporary email address</p>
        </div>
        <div class="flex justify-center mb-6">
            <button class="bg-blue-500 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded mr-4" onclick="generateNewMail()">Generate New Mail</button>
            <button class="bg-green-500 hover:bg-green-700 text-white font-bold py-2 px-4 rounded" onclick="refreshEmails()">Refresh Mails</button>
        </div>
        <div class="text-center mb-6">
            <p class="text-xl">Current Email: <span id="currentEmail" class="font-mono text-blue-600"></span>
            <button id="copyButton" class="copy-button" onclick="copyToClipboard()">Copy</button></p>
        </div>
        <div id="emailList" class="bg-white p-6 rounded-lg shadow-lg">
            <!-- Emails will be displayed here -->
        </div>
    </div>

</body>
</html>
